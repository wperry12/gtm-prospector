<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTM Prospector</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="header">
        <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="Lorikeet Logo">
    </div>

    <div id="app" class="app main-content {{ 'state-results' if (request.method == 'POST' and company_name) else 'state-search' }}">
        <h1>GTM Prospector</h1>

        <section class="view view-search">
            <div class="results-header collapsed" style="max-width: 760px; margin: 0 auto;">
                <div class="card pad">
                    <form id="searchForm" action="/" method="post" class="search-bar">
                        <input type="text" name="company_name" placeholder="Enter company name to analyze..." value="{{ company_name }}" required>
                        <div style="display:flex; gap:8px;">
                            <button class="primary" type="submit" name="analyze_button">Search</button>
                            <button id="openUpload" class="secondary" type="button">Upload Connections</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <section class="view view-loading">
            <div class="card pad loading-wrap" style="display:flex; max-width:720px; margin: 40px auto;">
                <div class="spinner"></div>
                <div class="subtle"><strong>Analyzing company data...</strong> This may take up to 60 seconds.</div>
            </div>
        </section>

        <section class="view view-results">
            <div class="results-header collapsed">
                <div class="card pad">
                    <form id="searchFormTop" action="/" method="post" class="search-bar">
                        <input type="text" name="company_name" placeholder="Enter company name to analyze..." value="{{ company_name }}" required>
                        <div style="display:flex; gap:8px;">
                            <button class="primary" type="submit" name="analyze_button">Search</button>
                            <button id="openUploadTop" class="secondary" type="button">Upload Connections</button>
                        </div>
                    </form>
                </div>
            </div>

            {% if request.method == 'POST' and company_name %}
            <div class="card" style="margin-top:16px;">
                <div class="tabs">
                    <button class="tab-btn active" data-tab="ai">AI Strategy</button>
                    {% if prioritized_prospects %}<button class="tab-btn" data-tab="org">Org Structure</button>{% endif %}
                    {% if gtm_strategy_html %}<button class="tab-btn" data-tab="gtm">GTM Plan</button>{% endif %}
                </div>
                <div class="tab-panel active" id="panel-ai">
                    <div id="ai-scorecard" class="card pad" style="margin:12px;">
                        <h3 style="margin-top:0;">Prospect Scorecard</h3>
                        <div id="scorecard-content">{{ scorecard_html | safe }}</div>
                    </div>
                    <div id="ai-briefing" class="card pad" style="margin:12px;">
                        <h3 style="margin-top:0;">Detailed Briefing</h3>
                        <div id="briefing-content">{{ briefing_html | safe }}</div>
                    </div>
                    {% if sources %}
                    <div class="card pad" style="margin:12px;">
                        <h4 style="margin:0 0 6px;">Sources Used</h4>
                        <ul class="sources-list">
                            {% for source in sources %}<li><a href="{{ source.link }}" target="_blank" rel="noopener noreferrer">{{ source.title }}</a></li>{% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>

                {% if prioritized_prospects %}
                <div class="tab-panel" id="panel-org">
                    <div class="card pad" style="margin:12px;">
                        <h3 style="margin-top:0;">Org Structure</h3>
                        <table>
                            <thead><tr><th>Name</th><th>Job Title</th><th>Internal Connection?</th></tr></thead>
                            <tbody>
                            {% for person in prioritized_prospects %}
                            <tr>
                                <td>{{ person.name }}</td>
                                <td>{{ person.role }}</td>
                                <td class="{{ 'connection-found' if person.connection_status }}">
                                    {% if person.connection_status %}
                                        Connected (via {{ person.connected_with }})
                                    {% else %}
                                        No Connection
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}

                {% if gtm_strategy_html %}
                <div class="tab-panel" id="panel-gtm">
                    <div class="card pad" style="margin:12px;">
                        <h3 style="margin-top:0;">GTM Outreach Plan</h3>
                        {{ gtm_strategy_html | safe }}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </section>
    </div>

    <div id="uploadModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="modal">
            <div class="header"><strong>Upload LinkedIn Connections</strong><button id="closeUpload" class="link">Close</button></div>
            <div class="content">
                <form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data">
                    <label for="salesperson_name" class="subtle">Your Name</label>
                    <select name="salesperson_name" id="salesperson_name" required style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
                        <option value="William Perry">William Perry</option>
                    </select>
                    <div style="height:8px"></div>
                    <input type="file" name="csv_file" accept=".csv" required>
                    <div class="subtle" style="margin-top:6px;">CSV exported from LinkedIn.</div>
                    <div class="footer">
                        <button type="button" id="closeUpload2" class="secondary">Close</button>
                        <button type="submit" class="primary">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>